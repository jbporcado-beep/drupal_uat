<?php

use Drupal\Core\Entity\EntityTypeInterface;
use Drupal\Core\Entity\EntityInterface;
use Drupal\diff\DiffEntityComparison;
use Drupal\Component\Serialization\Json;
use Drupal\Core\Url;
use Drupal\admin\Service\UserActivityLogger;
use Drupal\Core\Session\AccountInterface;
use Drupal\Core\Session\AccountProxy;
use Drupal\Core\Form\FormStateInterface;

function admin_user_logout(AccountInterface $account) {
  $activity_logger = \Drupal::service('admin.user_activity_logger');

  $data = [
    'changed_fields' => [],
  ];

  $activity_logger->log('Successfully logged out.', 'user', $account->id(), $data, NULL, $account);
  
  $tempstore = \Drupal::service('tempstore.private')->get('dashboard_store');
  $tempstore->delete('coop_dropdown');
}

function admin_user_login(AccountInterface $account) {
  $activity_logger = \Drupal::service('admin.user_activity_logger');

  $data = [
    'changed_fields' => [],
    'performed_by_name' => $account->getDisplayName(),
  ];
  $activity_logger->log('Successfully logged in.', 'user', $account->id(), $data, NULL, $account);
}

function admin_mail($key, &$message, $params) {
  switch ($key) {
    case 'custom_password_reset':
      $user = $params['user'];
      $site_name = \Drupal::config('system.site')->get('name');
      $full_name = $user->get('field_full_name')->value ?? $user->getAccountName();
      $username_masked = mask_username($user->getAccountName());
      $link = $params['link'];

      $message['subject'] = t('Welcome to the Pinoy Coop Data Information Sharing System (PCDISS)!');

      $message['body'][] = t('Hello @name,', ['@name' => $full_name]);
      $message['body'][] = t('Your account has been successfully created on Pinoy Coop Data Information Sharing System (PCDISS)');
      $message['body'][] = t('Registered Username: @username', ['@username' => $username_masked]);
      $message['body'][] = t('To activate your account and set up your password, please click the secure link below:');
      $message['body'][] = $link;
      $message['body'][] = t('This link is valid for one-time use only and will expire in 24 hours.');
      $message['body'][] = t('Please do not share this link with anyone.');
      $message['body'][] = t('If you did not request this account or need assistance, contact support@pinoycoop.');
      $message['body'][] = t('Thank you,');
      $message['body'][] = t('The Pinoy Coop Team');
      break;
  }
}

function mask_username($username) {
  if (strpos($username, '@') !== FALSE) {
    $parts = explode('@', $username);
    $name = $parts[0];
    $domain = $parts[1];
    $name_masked = substr($name, 0, 1) . str_repeat('*', max(0, strlen($name) - 1));
    return $name_masked . '@' . $domain;
  }
  return $username;
}

function admin_init() {
  $current_path = \Drupal::service('path.current')->getPath();

  if ($current_path === '/login-summary/download') {
    $current_user = \Drupal::currentUser();
    $activityLogger = \Drupal::service('admin.user_activity_logger');

    $data = [
      'changed_fields' => [],
      'performed_by_name' => $current_user->getDisplayName(),
    ];

    $action = 'Generated System Logins report.';
    $activityLogger->log($action, 'system', NULL, $data);
  }
}

function admin_views_data() {
  $data = [];
  
  $data['user_activity_log']['table'] = [
    'group' => t('User Activity Logs'),
    'base' => [
      'field' => 'id',
      'title' => t('User Activity Log'),
      'help' => t('Stores user activity logs.'),
      'weight' => 0,
    ],
  ];
  
  $data['user_activity_log']['id'] = [
    'title' => t('ID'),
    'help' => t('Primary key'),
    'field' => [
      'id' => 'numeric',
    ],
    'sort' => [
      'id' => 'standard',
    ],
    'filter' => [
      'id' => 'numeric',
    ],
    'argument' => [
      'id' => 'numeric',
    ],
  ];
  
  $data['user_activity_log']['user_id'] = [
    'title' => t('User ID'),
    'help' => t('The user who performed the action'),
    'field' => [
      'id' => 'numeric',
    ],
    'filter' => [
      'id' => 'numeric',
    ],
    'argument' => [
      'id' => 'numeric',
    ],
    'relationship' => [
      'title' => t('User'),
      'help' => t('The user who performed the action'),
      'base' => 'users_field_data',
      'base field' => 'uid',
      'id' => 'standard',
      'label' => t('User'),
    ],
  ];
  
  $data['user_activity_log']['performed_by'] = [
    'title' => t('Performed By ID'),
    'help' => t('User who performed the action'),
    'field' => [
      'id' => 'numeric',
    ],
    'filter' => [
      'id' => 'numeric',
    ],
    'argument' => [
      'id' => 'numeric',
    ],
    'relationship' => [
      'title' => t('Performed By'),
      'help' => t('The user who performed this action'),
      'base' => 'users_field_data',
      'base field' => 'uid',
      'id' => 'standard',
      'label' => t('Performed By User'),
    ],
  ];
  
  $data['user_activity_log']['action'] = [
    'title' => t('Action'),
    'help' => t('The action performed'),
    'field' => [
      'id' => 'standard',
    ],
    'filter' => [
      'id' => 'string',
    ],
    'sort' => [
      'id' => 'standard',
    ],
    'argument' => [
      'id' => 'string',
    ],
  ];
  
  $data['user_activity_log']['entity_type'] = [
    'title' => t('Entity Type'),
    'help' => t('Type of entity affected'),
    'field' => [
      'id' => 'standard',
    ],
    'filter' => [
      'id' => 'string',
    ],
    'sort' => [
      'id' => 'standard',
    ],
    'argument' => [
      'id' => 'string',
    ],
  ];
  
  $data['user_activity_log']['entity_id'] = [
    'title' => t('Entity ID'),
    'help' => t('ID of the affected entity'),
    'field' => [
      'id' => 'numeric',
    ],
    'sort' => [
      'id' => 'standard',
    ],
    'filter' => [
      'id' => 'numeric',
    ],
    'argument' => [
      'id' => 'numeric',
    ],
  ];
  
  $data['user_activity_log']['data'] = [
    'title' => t('Data'),
    'help' => t('JSON-encoded extra information'),
    'field' => [
      'id' => 'standard',
    ],
  ];

  $data['user_activity_log']['summary'] = [
    'title' => t('Summary'),
    'help' => t('Preformatted human readable summary.'),
    'field' => [
      'id' => 'standard',
    ],
  ];

  
  $data['user_activity_log']['created'] = [
    'title' => t('Created'),
    'help' => t('Timestamp when the action was performed'),
    'field' => [
      'id' => 'date',
      'click sortable' => TRUE,
    ],
    'sort' => [
      'id' => 'date',
    ],
    'filter' => [
      'id' => 'date',
    ],
  ];
  
  $data['user_activity_log']['changed_summary'] = [
    'title' => t('Changed Fields'),
    'help' => t('Displays only the fields that changed in the log'),
    'field' => [
      'id' => 'changed_summary',
    ],
  ];
  
  return $data;
}

function admin_entity_update(EntityInterface $entity) {
  $watched_fields = [
    'user' => ['mail', 'roles', 'field_bio'],
    'node' => ['title', 'field_coop_code', 'field_coop_name', 'body'],
  ];

  $entity_type = $entity->getEntityTypeId();
  if (empty($watched_fields[$entity_type])) {
    return;
  }

  if (empty($entity->original)) {
    return;
  }
  $original = $entity->original;

  $use_diff = \Drupal::moduleHandler()->moduleExists('diff');
  $diff_builder = NULL;
  if ($use_diff) {
    try {
      $diff_builder = \Drupal::service('diff.diff_builder');
    } catch (\Throwable $e) {
      $use_diff = FALSE;
    }
  }

  $changed_fields = [];

  foreach ($watched_fields[$entity_type] as $field_name) {
    if ($entity_type === 'user' && $field_name === 'roles') {
      $old_roles = $original->getRoles();
      $new_roles = $entity->getRoles();
      sort($old_roles);
      sort($new_roles);
      if ($old_roles !== $new_roles) {
        $changed_fields['roles'] = [
          'from' => implode(', ', $old_roles),
          'to' => implode(', ', $new_roles),
        ];
      }
      continue;
    }

    $handled_by_diff = FALSE;
    if ($use_diff && $diff_builder) {
      try {
        $comparison = new DiffEntityComparison($entity, $original, $diff_builder);
        $differences = $comparison->getDiff();
        if (!empty($differences[$field_name])) {

          $left_html = $differences[$field_name]['left'] ?? '';
          $right_html = $differences[$field_name]['right'] ?? '';
          $left_text = trim(strip_tags((string) $left_html));
          $right_text = trim(strip_tags((string) $right_html));
          if ($left_text !== $right_text) {
            $changed_fields[$field_name] = ['from' => $left_text, 'to' => $right_text];
          }
          $handled_by_diff = TRUE;
        }
      } catch (\Throwable $t) {
        $handled_by_diff = FALSE;
      }
    }

    if ($handled_by_diff) {
      continue;
    }

    $old_raw = NULL;
    $new_raw = NULL;
    try {
      if ($original->hasField($field_name)) {
        $old_raw = $original->get($field_name)->getValue();
        $new_raw = $entity->get($field_name)->getValue();
      } else {
        $old_raw = $original->get($field_name)->getValue();
        $new_raw = $entity->get($field_name)->getValue();
      }
    } catch (\Throwable $e) {
      continue;
    }

    $old_text = _admin_normalize_field_value($old_raw);
    $new_text = _admin_normalize_field_value($new_raw);
    if ($old_text !== $new_text) {
      $changed_fields[$field_name] = ['from' => $old_text, 'to' => $new_text];
    }
  }

  if (!empty($changed_fields)) {
    $key = 'admin_changed_fields:' . $entity_type . ':' . $entity->id();
    \Drupal::request()->attributes->set($key, $changed_fields);
  }
}


function _admin_normalize_field_value($raw) {
  if (is_null($raw)) {
    return '';
  }
  if (is_scalar($raw)) {
    return (string) $raw;
  }
  if (is_array($raw)) {
    $items = [];
    foreach ($raw as $item) {
      if (is_array($item) && isset($item['value'])) {
        $items[] = (string) $item['value'];
      } elseif (is_array($item) && isset($item['target_id'])) {
        $items[] = (string) $item['target_id'];
      } else {
        $items[] = Json::encode($item);
      }
    }
    return implode(', ', $items);
  }
  return Json::encode($raw);
}

function admin_page_top(array &$page_top) {
  $current_path = \Drupal::service('path.current')->getPath();
  $route_name = \Drupal::routeMatch()->getRouteName();

  if ($route_name !== 'massspecc.home') {
    $tempstore = \Drupal::service('tempstore.private')->get('dashboard_store');
    $tempstore->delete('coop_dropdown');
  }
}

function admin_form_user_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  if (!isset($form['field_cooperative']) || !isset($form['field_branch'])) {
    return;
  }

  $roles = \Drupal::currentUser()->getRoles();
  $is_super = in_array('superadmin', $roles, TRUE) || in_array('mass_specc', $roles, TRUE);

  $cooperative_options = ['' => t('- Select a cooperative -')];
  $coop_nids = \Drupal::entityQuery('node')
    ->condition('type', 'cooperative')
    ->condition('field_coop_status', 1)
    ->accessCheck(FALSE)
    ->execute();
  if ($coop_nids) {
    $coops = \Drupal\node\Entity\Node::loadMultiple($coop_nids);
    foreach ($coops as $n) {
      if ($n instanceof \Drupal\node\NodeInterface) {
        $cooperative_options[$n->id()] = $n->label();
      }
    }
  }

  $coop_el = &$form['field_cooperative']['widget'][0]['target_id'];
  $branch_el = &$form['field_branch']['widget'][0]['target_id'];

  $coop_el['#type'] = 'select';
  $coop_el['#options'] = $cooperative_options;
  $coop_el['#empty_option'] = t('- Select a cooperative -');
  $coop_el['#ajax'] = ['callback' => 'admin_update_branch_field', 'event' => 'change', 'wrapper' => 'branch-wrapper', 'progress' => ['type' => 'throbber']];
  $coop_el['#disabled'] = $is_super;

  $branch_el['#type'] = 'select';
  $branch_el['#options'] = ['' => t('- Select a branch -')];
  $branch_el['#empty_option'] = t('- Select a branch -');
  $branch_el['#prefix'] = '<div id="branch-wrapper">';
  $branch_el['#suffix'] = '</div>';
  $branch_el['#disabled'] = $is_super;

  $selected_coop = _admin_normalize_coop_value($form_state->getValue('field_cooperative'));
  if ($selected_coop && is_numeric($selected_coop)) {
    $branch_nodes = \Drupal::entityTypeManager()->getStorage('node')->loadByProperties([
      'type' => 'branch',
      'field_branch_coop' => (int) $selected_coop,
      'status' => 1,
    ]);
    $opts = ['' => t('- Select a branch -')];
    foreach ($branch_nodes as $bn) {
      if ($bn instanceof \Drupal\node\NodeInterface) {
        $opts[$bn->id()] = $bn->label();
      }
    }
    $branch_el['#options'] = $opts;
    $branch_el['#default_value'] = $form_state->getValue(['field_branch', 0, 'target_id']) ?? ($branch_el['#default_value'] ?? '');
    $branch_el['#required'] = !empty($selected_coop);
  } else {
    $branch_el['#options'] = ['' => t('- Select a branch -')];
    $branch_el['#default_value'] = '';
    $branch_el['#required'] = FALSE;
  }
}

function admin_update_branch_field(array &$form, FormStateInterface $form_state) {
  $coop_val = _admin_normalize_coop_value($form_state->getValue('field_cooperative'));
  $branch_el = $form['field_branch']['widget'][0]['target_id'];

  $options = ['' => t('- Select a branch -')];
  if (!empty($coop_val) && is_numeric($coop_val)) {
    $nodes = \Drupal::entityTypeManager()->getStorage('node')->loadByProperties([
      'type' => 'branch',
      'field_branch_coop' => (int) $coop_val,
      'status' => 1,
    ]);
    foreach ($nodes as $n) {
      if ($n instanceof \Drupal\node\NodeInterface) {
        $options[$n->id()] = $n->label();
      }
    }
  }

  $select = [
    '#type' => 'select',
    '#title' => $branch_el['#title'] ?? t('Branch'),
    '#options' => $options,
    '#empty_option' => t('- Select a branch -'),
    '#parents' => $branch_el['#parents'] ?? ['field_branch', 0, 'target_id'],
    '#default_value' => $form_state->getValue(['field_branch', 0, 'target_id']) ?? ($branch_el['#default_value'] ?? ''),
    '#name' => $branch_el['#name'] ?? NULL,
    '#prefix' => '<div id="branch-wrapper">',
    '#suffix' => '</div>',
  ];

  $role_val = $form_state->getValue('roles') ?: $form_state->getValue('role');
  $is_approver = ($role_val === 'approver') || (is_array($role_val) && in_array('approver', $role_val, TRUE));
  if (!$is_approver) {
    $select['#required'] = TRUE;
  } else {
    $select['#required'] = FALSE;
  }

  return $select;
}

function _admin_normalize_coop_value($val) {
  if (is_array($val)) {
    if (isset($val[0]) && is_array($val[0]) && isset($val[0]['target_id'])) {
      return $val[0]['target_id'];
    }
    if (isset($val['target_id'])) {
      return $val['target_id'];
    }
    if (!empty($val)) {
      return reset($val);
    }
    return NULL;
  }
  return $val;
}


function admin_views_post_execute(\Drupal\views\ViewExecutable $view) {
  $targets = [
    'login_summary' => [
      'display' => 'login_summary_export',
      'message' => 'Generated System Logins report.',
    ],
    'user_activity_logs' => [
      'display' => 'activity_logs_export',
      'message' => 'Generated Activity Log report.',
    ],
  ];

  $view_id = $view->id();
  $display_id = $view->current_display;

  if (!isset($targets[$view_id]) || $targets[$view_id]['display'] !== $display_id) {
    return;
  }

  $current_uid = \Drupal::currentUser()->id();
  $current_user_entity = \Drupal\user\Entity\User::load($current_uid);
  $data = [];
  $activity_logger = \Drupal::service('admin.user_activity_logger');
  $message = $targets[$view_id]['message'];

  $activity_logger->log($message, 'export', $current_uid, $data, NULL, $current_user_entity);
}


