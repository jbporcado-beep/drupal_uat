<?php

use Drupal\Core\Entity\EntityTypeInterface;

/**
 * Cooperative Fields Entity Validation.
 */
function admin_entity_bundle_field_info_alter(array &$fields, EntityTypeInterface $entity_type, $bundle) {
  if ($entity_type->id() === 'node' && $bundle === 'cooperative') {
    // Fields that must be alphanumeric.
    $alphanumeric_fields = [
      'field_coop_code',
      'field_cic_provider_code',
    ];

    foreach ($alphanumeric_fields as $field_name) {
      if (isset($fields[$field_name])) {
        $fields[$field_name]->setPropertyConstraints('value', [
          'Alphanumeric' => [],
        ]);
      }
    }

    $ph_mobile_fields = [
      'field_coop_contact_number',
    ];

    foreach ($ph_mobile_fields as $field_name) {
      if (isset($fields[$field_name])) {
        $fields[$field_name]->setPropertyConstraints('value', [
          'PhMobileNumber' => [],
        ]);
      }
    }
  }
}


/**
 * Implements hook_mail().
 */
function admin_mail($key, &$message, $params) {
  switch ($key) {
    case 'custom_password_reset':
      $user = $params['user'];
      $site_name = \Drupal::config('system.site')->get('name');
      $full_name = $user->get('field_full_name')->value ?? $user->getAccountName();
      $username_masked = mask_username($user->getAccountName());
      $link = $params['link'];

      $message['subject'] = t('Welcome to @site!', ['@site' => $site_name]);

      $message['body'][] = t('Hello @name,', ['@name' => $full_name]);
      $message['body'][] = t('Your account has been successfully created on @site.', ['@site' => $site_name]);
      $message['body'][] = t('Registered Username: @username', ['@username' => $username_masked]);
      $message['body'][] = t('To activate your account and set up your password, please click the secure link below:');
      $message['body'][] = $link;
      $message['body'][] = t('This link is valid for one-time use only and will expire in 24 hours.');
      $message['body'][] = t('Please do not share this link with anyone.');
      $message['body'][] = t('If you did not request this account or need assistance, contact support@pinoycoop.');
      $message['body'][] = t('Thank you,');
      $message['body'][] = t('The Pinoy Coop Team');
      break;
  }
}

/**
 * Example helper to mask username/email partially.
 */
function mask_username($username) {
  if (strpos($username, '@') !== FALSE) {
    $parts = explode('@', $username);
    $name = $parts[0];
    $domain = $parts[1];
    $name_masked = substr($name, 0, 1) . str_repeat('*', max(0, strlen($name) - 1));
    return $name_masked . '@' . $domain;
  }
  return $username;
}
