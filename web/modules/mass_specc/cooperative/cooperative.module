<?php
use Drupal\Core\Url;
use Drupal\user\Entity\User;
use Drupal\views\ViewExecutable;
use Drupal\Core\Session\AccountInterface;
use Drupal\views\Plugin\views\query\QueryPluginBase;
use Drupal\node\Entity\Node;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Session\AccountProxy;
use Drupal\file\FileInterface;

/**
 * Validates CSV upload by extension and size only (no MIME check).
 * Allows files to stay in the field so Verify can run and show data errors.
 *
 * @param \Drupal\file\FileInterface $file
 *   The file entity.
 * @param int $max_size
 *   Maximum file size in bytes.
 *
 * @return array
 *   Array of error messages, or empty array if valid.
 */
function cooperative_validate_csv_upload(FileInterface $file, $max_size) {
  $errors = [];
  $filename = $file->getFilename();
  $ext = strtolower(pathinfo($filename, PATHINFO_EXTENSION));
  if ($ext !== 'csv') {
    $errors[] = t('Only CSV files are allowed. Found extension: @ext', ['@ext' => $ext ?: 'none']);
  }
  if ($file->getSize() > $max_size) {
    $errors[] = t('The file is too large. Maximum size is @max MB.', [
      '@max' => round($max_size / 1048576, 1),
    ]);
  }
  return $errors;
}

/**
 * Implements hook_entity_presave().
 */
function cooperative_entity_presave(EntityInterface $entity) {
  $generator = \Drupal::service('cooperative.code_generator');

  // Members and Companies
  if ($entity->getEntityTypeId() === 'node' && in_array($entity->bundle(), ['member', 'company'])) {
    if ($entity->hasField('field_msp_subject_code') && empty($entity->get('field_msp_subject_code')->value)) {
      $prefix = $entity->bundle() === 'member' ? 'I' : 'C';
      $entity->set('field_msp_subject_code', $generator->generateMemberCode($prefix));
    }
  }

  // Contracts
  if ($entity->getEntityTypeId() === 'node' && in_array($entity->bundle(), ['installment_contract', 'noninstallment_contract'])) {
    if ($entity->hasField('field_msp_contract_code') && empty($entity->get('field_msp_contract_code')->value)) {
      $entity->set('field_msp_contract_code', $generator->generateContractCode());
    }
  }

   if ($entity->getEntityTypeId() === 'node' && $entity->bundle() === 'branch') {
    if ($entity->hasField('field_branch_code') && $entity->get('field_branch_code')->isEmpty()) {
      // generateBranchCode() should return a unique code like "25001".
      $entity->set('field_branch_code', $generator->generateBranchCode());
    }
  }
}


function cooperative_theme($existing, $type, $theme, $path) {
  return [
    'member_credit_report' => [
      'variables' => ['data' => NULL],
      'template' => 'member-credit-report',
      'path' => $path . '/templates',
      'libraries' => ['cooperative/member_credit_report'],
    ],
  ];
}

/**
 * Implements hook_views_query_alter().
 */
function cooperative_views_query_alter(ViewExecutable $view, QueryPluginBase $query) {
  
  if ($view->id() === 'file_history') {
    $view->element['#cache']['contexts'][] = 'user';
    $account = \Drupal::currentUser();
    $user = User::load($account->id());

    $user_coop_id = $user->get('field_cooperative')->target_id ?? NULL;
    $user_branch_id = $user->get('field_branch')->target_id ?? NULL;

    if ($account->hasRole('approver') && $user_coop_id) {
      $query->addWhere(0, 'node__field_cooperative.field_cooperative_target_id', $user_coop_id, '=');
      return;
    }
    elseif ($account->hasRole('uploader') && $user_branch_id) {
      $query->addWhere(0, 'node__field_branch.field_branch_target_id', $user_branch_id, '=');
      return;
    }
  } 

  elseif ($view->id() === 'report_templates_list' && $view->current_display === 'coop_reports_template_list') {
    $user = User::load(\Drupal::currentUser()->id());
    if (!$user) {
      $query->addWhereExpression(0, '1=0');
      return;
    }

    $coop_nid = $user->get('field_cooperative')->target_id ?? NULL;
    if (!$coop_nid) {
      $query->addWhereExpression(0, '1=0');
      return;
    }

    $coop_node = Node::load($coop_nid);
    if (!$coop_node) {
      $query->addWhereExpression(0, '1=0');
      return;
    }

    $assigned_templates = $coop_node->get('field_assigned_report_templates')->getValue() ?? [];
    $template_nids = array_map(fn($item) => $item['target_id'], $assigned_templates);

    if (empty($template_nids)) {
      $query->addWhereExpression(0, '1=0');
      return;
    }

    $query->addWhere('AND', 'node_field_data.nid', $template_nids, 'IN');
  }
}


/**
 * Implements hook_preprocess_views_view_field().
 */
function cooperative_preprocess_views_view_field(array &$variables) {
    $target_view_id = 'file_history';
    $target_field_id = 'nothing'; 

    $view_id = $variables['view']->id();
    $field_id = $variables['field']->options['id'];

    if ($view_id === $target_view_id && $field_id === $target_field_id) {
        $variables['#attached']['library'][] = 'mass_specc_bootstrap_sass/file-upload-styles';
        $variables['#attached']['library'][] = 'cooperative/file-status-handler';

        $account = \Drupal::currentUser(); 
        $roles = $account->getRoles();

        $entity = $variables['row']->_entity;
        if (empty($entity) || $entity->bundle() !== 'file_upload_history') {
            return;
        }
        $node_id = $entity->id();

        $file_handler = $variables['view']->field['field_file'];
        $file_url = (string) $file_handler->last_render; 
        $safe_file_url = \Drupal\Component\Utility\Html::escape($file_url);
        
        if (empty($file_url)) {
            $file_url = '#'; 
        }

        $html = '<div class="action-cell-container">';
        $html .= '<div class="download-icon-container">';
        $html .= '<a href="' . $safe_file_url . '" download>';
        $html .= '<i class="fas fa-download"></i>';
        $html .= '</a>';
        $html .= '</div>';

        $status_value = $entity->get('field_status')->value ?? 'Unknown';
        if (in_array('approver', $roles) && $status_value === 'Pending') {
            $approve_url = Url::fromRoute('cooperative.file_status_approve', ['node' => $node_id])->toString();
            $reject_url = Url::fromRoute('cooperative.file_status_reject', ['node' => $node_id])->toString();

            $html .= '<div class="file-actions">';
            $html .= '<a href="#" class="file-action-link action-approve" 
                            data-action="approve" 
                            data-node-id="' . $node_id . '" 
                            data-action-url="' . $approve_url . '">
                        Approve
                        </a>';

            $html .= '<a href="#" class="file-action-link action-reject" 
                            data-action="reject" 
                            data-node-id="' . $node_id . '" 
                            data-action-url="' . $reject_url . '">
                        Reject
                        </a>';
            $html .= '</div>';
        }
        else if (in_array('approver', $roles) && $status_value !== 'Pending') {
            $html .= '<span class="file-upload-status">' . htmlspecialchars($status_value) . '</span>';
        }
        $html .= '</div>';

        $variables['output'] = [
            '#markup' => $html,
        ];
    }
}

/**
 * Implements hook_views_pre_render().
 */
function cooperative_views_pre_render(ViewExecutable $view) {
  $target_view_id = 'file_history';
  $target_field_id = 'field_status'; 

  $restricted_role = 'approver';

  if ($view->id() !== $target_view_id) {
    return;
  }

  $user = \Drupal::currentUser();

  if ($user->hasRole($restricted_role)) {
    unset($view->field[$target_field_id]);
  }
}
/**
 * Implements hook_page_top().
 */
function cooperative_page_top(array &$page_top) {
  $current_path = \Drupal::service('path.current')->getPath();
  $route_name = \Drupal::routeMatch()->getRouteName();

  if ($route_name !== 'cooperative.dashboard') {
    $tempstore = \Drupal::service('tempstore.private')->get('dashboard_store');
    $tempstore->delete('branch_dropdown');
  }
}
/**
 * Implements hook_user_logout().
 */
function cooperative_user_logout(AccountProxy $account) {
  $tempstore = \Drupal::service('tempstore.private')->get('dashboard_store');
  $tempstore->delete('branch_dropdown');
}

?>